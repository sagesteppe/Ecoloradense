---
title: "Modelling First Iteration of Eriogonum coloradense"
author: "steppe"
output: html_document
---


```{r}
library(tidyverse)
library(sf)
library(terra)
```


```{r import spatial data}
occurrence_data <- st_read(
  '../data/collections/occurrences_coloradense/occurrences.shp', quiet = T)
absence_data <- st_read(
  '../data/spatial/processed/pseudo-absences/iteration1/absences.shp', quiet = T)
rastReader <- function(x){
  
  p <- paste0('../data/spatial/processed/', x, '/geomorphology/')
  f <- paste0(p, list.files(p))
  
  f <- f[! grepl('D8pntr|basins', f) ] # remove the D8pntr & Basins 
  s <- terra::rast(f)
  
}

stack <- rastReader('dem_1arc') 



```


Using Boruta analysis we will drop features which evidently show absolutely no relation to the individuals marks. 

```{r}

BorutaRes <- Boruta::Boruta(Occurrence ~ ., data = x, num.threads = cores, doTrace = 1)
importance <- Boruta::attStats(BorutaRes)
rn <- rownames(importance)
important_vars <- Boruta::getSelectedAttributes(BorutaRes, withTentative = F)
  
 
  sdm_data_obj <- sdmData(formula=occurrence~., 
                          train = taxon, 
                          predictors = WPDPV2)
  sdm_model <- sdm(formula = occurrence~., 
                   data = sdm_data_obj, 
                   methods = c('rf','brt'), replication='sub', test.percent=30, n=2)
  
  fname <- paste0(here(), '/results/maps/', binomial, "_ml_", Sys.time(),'.tif')
  fname <- gsub(' ', '_', fname)
  sdm_ensemble_prediction <- sdm::ensemble(sdm_model, WPDPV2, 
                                           setting = list(method = "weighted", stat = 'tss', opt = 2), 
                                           filename = fname)
  
```

