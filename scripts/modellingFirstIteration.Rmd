---
title: "Modelling First Iteration of Eriogonum coloradense"
author: "steppe"
output: html_document
---


```{r}
library(sf)
library(tidyverse)
library(terra)
source('functions.R')
set.seed(23)
```


```{r import spatial data}

occ_data <- bind_rows(
  st_read('../data/collections/occurrences_coloradense/occurrences.shp', quiet = T) %>% 
    mutate(Occurrence = 1) %>% 
    st_transform(32613),
  st_read('../data/spatial/processed/pseudo-absences/iteration1/absences.shp', quiet = T) 
)

res <- c('3arc', '1arc', '1-3arc', '3m')
p2proc <- '../data/spatial/processed'

```

First iteration of modelling. 

```{r}
modeller(x = occ_data, resolution = '1-3arc', iteration = 1)
```

Drawing Field 

```{r}

trails <- st_read('../data/hikingTrails/MtBaldyRoute.shp') %>% 
  st_make_valid() %>% 
  st_transform(32613) %>% 
  st_buffer(45)

pts <- st_sample(trails, size = 500, type = 'random') %>% 
  st_as_sf() %>% 
  st_transform(4326) %>% 
  rename(geometry = x) %>% 
   mutate(
    Longitude = unlist(map(.$geometry,1)),
    Latitude = unlist(map(.$geometry,2)), 
    Species = 'Points'
  )

thinned <- spThin::thin( # no points found within 90m of each other !
  loc.data = pts, lat.col = 'Latitude', long.col = 'Longitude', spec.col = 'Species',
  thin.par = 0.128, reps = 100, write.files = FALSE, write.log.file = FALSE, 
  locs.thinned.list.return = TRUE)

thinned <- thinned[[which.max(unlist(lapply(thinned, nrow)))]] %>% 
  st_as_sf(coords = c(x = 'Longitude', y = 'Latitude'), crs = 4326) %>% 
  mutate(ID = 1:nrow(.), .before = geometry)

# just checking again... 
# st_distance(thinned, thinned[ st_nearest_feature(thinned), ], by_element = T)

ggplot() +
  geom_sf(data = trails) +
  geom_sf(data = thinned)

st_write(thinned, '../data/GroundTruthPts/Iteration1.shp', append = TRUE)
rm(pts)
```

We are going to give the points sensible identification numbers based on which trail or area they are located in . 
First we need to update the 'Trails' dataset so that small branches of trails are joined to their main trunk.
```{r}
tr <- trails %>% 
  mutate(id =case_when(
    id %in% c(2) ~ 1,
    id %in% c(9, 11) ~ 8,
    id %in% c(20) ~ 7,
    id %in% c(13, 14, 15, 16, 17, 18, 52) ~ 12,
    id %in% c(23, 24, 26, 44, 47) ~ 25, 
    id %in% c(27, 28) ~ 29, 
    id %in% c(33) ~ 30, 
    id %in% c(38, 39, 19) ~ 7,
    id %in% c(41, 42, 43) ~ 40, # north pole basin trails
    id %in% 48 ~ 51, 
    id %in% c(50) ~ 49,
    .default = as.numeric(id)
  )
) %>% 
  group_by(id) %>% 
  mutate(ID = cur_group_id()) %>% 
  ungroup() %>% 
  group_by(ID) %>% 
  summarize(geometry = st_union(geometry))


st_write(tr, '../data/hikingTrails/trails.shp', append=F)

```

